<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–ö–∞—Ä—Ç–∞ –ª–æ–∫–∞—Ü–∏–π</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }
    #map {
      width: 100vw;
      height: 100vh;
    }
    .theme-toggle {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      cursor: pointer;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    .notification {
      position: absolute;
      top: 50px;
      left: 10px;
      z-index: 1000;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      font-family: Arial, sans-serif;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      max-width: 300px;
      display: none;
    }
  </style>
</head>
<body>

<div class="theme-toggle" onclick="toggleTheme()">üåó –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</div>
<div class="notification" id="notification"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  let map, lightLayer, darkLayer, isDark = false;

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
  map = L.map('map').setView([55.7558, 37.6173], 13);

  // –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç—ã
  lightLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors, CartoDB'
  });

  darkLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors, CartoDB'
  });

  lightLayer.addTo(map);

  // –§—É–Ω–∫—Ü–∏—è —Å–º–µ–Ω—ã —Ç–µ–º—ã
  function toggleTheme() {
    if (isDark) {
      map.removeLayer(darkLayer);
      map.addLayer(lightLayer);
    } else {
      map.removeLayer(lightLayer);
      map.addLayer(darkLayer);
    }
    isDark = !isDark;
  }

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  function showNotification(message, isError = false) {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.style.display = 'block';
    notification.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';

    setTimeout(() => {
      notification.style.display = 'none';
    }, 5000);
  }

  // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞–¥–∏–∏ –æ–±—É—á–µ–Ω–∏—è
  async function updateTrainingStage(telegramId, newStage) {
    try {
      const response = await fetch('/api/user/update_training_stage', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          telegram_id: telegramId,
          new_training_stage: newStage
        })
      });

      const data = await response.json();

      if (data.status === 'error') {
        showNotification(`–û—à–∏–±–∫–∞: ${data.message}`, true);
        return false;
      }

      showNotification(`–°—Ç–∞–¥–∏—è –æ–±—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞: ${newStage}`);
      return true;
    } catch (error) {
      showNotification('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞–¥–∏–∏', true);
      return false;
    }
  }

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç—É
  async function loadMapData() {
    try {
      const response = await fetch('/api/all-map-data');
      const data = await response.json();

      data.locations.forEach(loc => {
        const marker = L.marker([loc.latitude, loc.longitude]).addTo(map);
        const popup = `
          <div style="font-family: Arial; font-size: 14px;">
            <b>${loc.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</b><br/>
            ${loc.username ? `<a href="https://t.me/${loc.username}" target="_blank">@${loc.username}</a><br/>` : ''}
            ${loc.description || ''}
          </div>
        `;
        marker.bindPopup(popup);
      });
    } catch (error) {
      showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã', true);
    }
  }

  // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≥–µ–æ–ø–æ–∑–∏—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  map.locate({ setView: true, maxZoom: 15 });

  map.on('locationfound', e => {
    const userMarker = L.circleMarker(e.latlng, {
      radius: 6,
      fillColor: '#3388ff',
      color: '#3388ff',
      weight: 2,
      opacity: 1,
      fillOpacity: 0.6
    }).addTo(map).bindPopup("–í—ã –∑–¥–µ—Å—å").openPopup();
  });

  map.on('locationerror', () => {
    showNotification("–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ", true);
  });

  // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  document.addEventListener('DOMContentLoaded', async () => {
    // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const telegramId = urlParams.get('uid');
    const newTrainingStage = urlParams.get('nts');

    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ URL, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞–¥–∏—é –æ–±—É—á–µ–Ω–∏—è
    if (telegramId && newTrainingStage) {
      await updateTrainingStage(telegramId, newTrainingStage);
    }

    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–∫–∏ –Ω–∞ –∫–∞—Ä—Ç—É
    await loadMapData();
  });
</script>

</body>
</html>